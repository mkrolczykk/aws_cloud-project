{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Cloudformation template for Amazon Big Data capstone project",
    "Parameters" : {
        "LambdaServiceRole": {
            "Type": "String",
            "Default": "arn:aws:iam::571632058847:role/lambda-role-mkrolczyk"
        },
        "FirehoseDeliveryStreamRole": {
            "Type": "String",
            "Default": "arn:aws:iam::571632058847:role/firehose-delivery-stream-mkrolczyk"
        },
        "SourceItemStreamName": {
            "Type": "String",
            "Default": "SourceItemStream-mkrolczyk"
        },
        "SourceReviewStreamName": {
            "Type": "String",
            "Default": "SourceReviewStream-mkrolczyk"
        },
        "S3DataBucketName": {
            "Type": "String",
            "Default": "mkrolczyk-data-capstone",
            "Description": "Name of S3 bucket to create for storing data"
        },
        "S3ResourcesBucketName": {
            "Type": "String",
            "Default": "mkrolczyk-project-resources",
            "Description": "Name of already existing S3 bucket with project resources"
        },
        "LambdaServiceFilterIpFunctionName": {
            "Type": "String",
            "Default": "LambdaServiceFilterIpFunction-mkrolczyk"
        },
        "FirehouseItemsDeliveryStreamName": {
            "Type": "String",
            "Default": "FirehouseItemsDeliveryStreamName-mkrolczyk"
        },
        "FirehouseReviewsDeliveryStreamName": {
            "Type": "String",
            "Default": "FirehouseReviewsDeliveryStreamName-mkrolczyk"
        },
        "DynamoDBSuspiciousIpsTableName": {
            "Type": "String",
            "Default": "DynamoDBSuspiciousIpsTable-mkrolczyk"
        }
    },
    "Resources": {
        "SourceItemStream": {
            "Type": "AWS::Kinesis::Stream",
            "RetentionPeriodHours" : 12,
            "ShardCount" : 1,
            "Properties" : {
                "Name" : { "Ref" : "SourceItemStreamName" }
            }
        },
        "SourceReviewStream": {
            "Type": "AWS::Kinesis::Stream",
            "RetentionPeriodHours" : 12,
            "ShardCount" : 1,
            "Properties" : {
                "Name" : { "Ref" : "SourceReviewStreamName" }
            }
        },
        "DataBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {
              "AccessControl": "Private",
              "BucketName": { "Ref" : "S3DataBucketName" }
            } 
        },
        "LambdaServiceFilterIpsFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": { "Ref" : "LambdaServiceFilterIpFunctionName" },
                "Role": {"Ref" : "LambdaServiceRole"},
                "Environment": {
                    "Variables": {
                        "FirehouseItemsDeliveryStreamName": { "Ref" : "FirehouseItemsDeliveryStreamName" },
                        "FirehouseReviewsDeliveryStreamName": { "Ref" : "FirehouseReviewsDeliveryStreamName" },
                        "DynamoDB_table": { "Ref" : "DynamoDBSuspiciousIpsTableName" }
                    }
                },
                "Code": {
                  "S3Bucket": { "Ref" : "S3ResourcesBucketName" },
                  "S3Key": "lambda_service_filter.zip"
                },
                "Handler": "lambda_service_filter.handler",
                "Runtime": "python3.9",
                "Timeout": 30
            }
        },
        "FirehouseItemsDeliveryStream": {
            "Type": "AWS::KinesisFirehose::DeliveryStream",
            "Properties": {
                "DeliveryStreamName": { "Ref" : "FirehouseItemsDeliveryStreamName" },
                "S3DestinationConfiguration": {
                    "BucketARN": { "Fn::GetAtt" : ["DataBucket", "Arn"] },
                    "RoleARN": { "Ref" : "FirehoseDeliveryStreamRole" }
                },
                "Prefix": "items_filtered_data/"
            }
        },
        "FirehouseReviewsDeliveryStream": {
            "Type": "AWS::KinesisFirehose::DeliveryStream",
            "Properties": {
                "DeliveryStreamName": { "Ref" : "FirehouseReviewsDeliveryStreamName" },
                "S3DestinationConfiguration": {
                    "BucketARN": { "Fn::GetAtt" : ["DataBucket", "Arn"] },
                    "RoleARN": { "Ref" : "FirehoseDeliveryStreamRole" }
                },
                "Prefix": "reviews_filtered_data/"
            }
        }
    },
    "Outputs": {
        "BucketName": {
          "Value": { "Ref" : "S3DataBucketName" }
        }
    }
}